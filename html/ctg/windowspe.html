
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>

<!--
	Copyright (c) 2001-2006 by Digital Mars
	All Rights Reserved
	www.digitalmars.com
  -->

<head>
<META http-equiv="content-type" content="text/html; charset=utf-8" >
<title>Digital Mars - Windows Prolog/Epilog Code Generation
</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<div id="heading">
<a href="http://www.digitalmars.com/"><IMG SRC="dmlogo.gif" BORDER=0 WIDTH=270 HEIGHT=53 ALT="www.digitalmars.com"></a>

<a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a>
| <a href="../advancedsearch.html" title="Search Digital Mars web site">Search</a>
| <a href="ctg.html" title="Compiler & Tools Guide">CTG</a>
| <a href="../rtl/rtl.html" title="Runtime Library Reference">RTL</a>
| <a href="../ugr/ugr.html" title="IDDE Reference">IDDE</a>
| <a href="../stl/index.html" title="Standard Template Library">STL</a>

	<div id="lastupdate">Last update Fri Apr 28 16:25:46 2006
</div>
</div>

<!-- Generated by Ddoc from windowspe.d -->




<table border=1 cellpadding=8 cellspacing=0 frame="void" summary="this table is for layout only">
<tr>
<td valign="top" class="toc" nowrap>
<small>
<center>
<form method="get" action="http://www.google.com/search">
<input id="q" name="q" size="10" value="Search" onFocus='if(this.value == "Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/ctg">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</form>
</center>

    <a href="ctg.html"><b>Compiler & Tools Guide</b></a><br>

<hr><b>Compiling</b><br>

    &#149; <a href="ctgCompilingCode.html">Compiling Code</a><br>
    &#149; <a href="C-Language-Implementation.html">C Implementation</a><br>
    &#149; <a href="CPP-Language-Implementation.html">C++ Implementation</a><br>
    &#149; <a href="ctgLanguageImplementation.html">Language Extensions</a><br>
    &#149; <a href="ctgMixingLanguages.html">Mixing Languages</a><br>
    &#149; <a href="ctgAsm.html">Assembly Language</a><br>
    &#149; <a href="ctgInlineAsm.html">Inline Assembler</a><br>
    &#149; <a href="ctgOptimizer.html">Optimizing Code</a><br>
    &#149; <a href="ctgNumerics.html">Numerics Programming</a><br>
    &#149; <a href="regular.html">Regular Expressions</a><br>
    &#149; <a href="acrtused.html">Acrtused</a><br>
    &#149; <a href="pragmas.html">Pragmas</a><br>
    &#149; <a href="precompiled.html">Precompiled Headers</a><br>
    &#149; <a href="predefined.html">Predefined Macros</a><br>
    &#149; <a href="warnings.html">Warning Messages</a><br>
    &#149; <a href="ctgCompilerErrors.html">Error Messages</a><br>
    &#149; <a href="warnings.html#runtime">Runtime Messages</a><br>
    <br>

<hr><b>Linking</b><br>

    &#149; <a href="optlink.html">Optlink</a><br>
    &#149; <a href="ctgLinkSwitches.html">Switches</a><br>
    &#149; <a href="ctgDefFiles.html">Module Definition Files</a><br>
    &#149; <a href="ctgLinkOps.html">Operation and Design</a><br>
    &#149; <a href="OptlinkErrorMessages.html">Error Messages</a><br>
    <br>

<hr><b>Win32 Programming</b><br>

    &#149; <a href="win32programming.html#win32">Win32 Programming</a><br>
    <br>

<hr><b>DOS and Win16<br>Programming</b><br>

    &#149; <a href="ctgMemoryModel.html">Memory Models</a><br>
    &#149; <a href="pointers16.html">16 Bit Pointer Types<br> and Type Modifiers</a><br>
    &#149; <a href="win32programming.html#handle">Handle Pointers</a><br>
    &#149; <a href="win32programming.html#dos">DOS</a><br>
    &#149; <a href="dos32.html">DOS 32 (DOSX)</a><br>
    &#149; <a href="win32programming.html#win16">Win16</a><br>
    &#149; <a href="win32programming.html#win16dll">Win16 DLLs</a><br>
    &#149; <a href="windowspe.html">Win16 Prolog/Epilog</a><br>
    <br>

<hr><b>C/C++ Extensions</b><br>

    &#149; <a href="contract.html">Contract Programming</a><br>
    &#149; <a href="debugstatement.html">__debug statement</a><br>
    &#149; <a href="debugstatement.html#debugdeclaration">__debug declaration</a><br>
    &#149; <a href="trace.html">Dynamic Profiling</a><br>
    &#149; <a href="html.html">Embedding C in HTML</a><br>
    <br>

<hr><b>Tools</b><br>

    &#149; <a href="bcc.html" title="Convert Borland compiler commands">BCC</a><br>
    &#149; <a href="chmod.html" title="Examine and change file attributes">CHMOD</a><br>
    &#149; <a href="cl.html" title="Convert Microsoft compiler commands">CL</a><br>
    &#149; <a href="coff2omf.html" title="Convert COFF .obj and .lib to OMF">COFF2OMF</a><br>
    &#149; <a href="coffimplib.html" title="Convert COFF import library OMF">COFFIMPLIB</a><br>
    &#149; <a href="sc.html" title="Compiler command">DMC</a><br>
    &#149; <a href="diff.html" title="Compare files">DIFF</a><br>
    &#149; <a href="diffdir.html" title="Compare directories">DIFFDIR</a><br>
    &#149; <a href="dump.html" title="Dump files in hex">DUMP</a><br>
    &#149; <a href="dumpobj.html" title="Dump object files in hex">DUMPOBJ</a><br>
    &#149; <a href="dumpexe.html" title="Dump exe files">DUMPEXE</a><br>
    &#149; <a href="exe2bin.html" title="Create .com files">EXE2BIN</a><br>
    &#149; <a href="flpyimg.html" title="Read/Write Floppy Image">FLPYIMG</a><br>
    &#149; <a href="grep.html" title="Search files for string">GREP</a><br>
    &#149; <a href="ctgHelp.html" title="Creating Help Tools">HC</a><br>
    &#149; <a href="implib.html" title="Build import libraries">IMPLIB</a><br>
    &#149; <a href="lib.html" title="Object file librarian">LIB</a><br>
    &#149; <a href="libunres.html" title="Analyze library and object files">LIBUNRES</a><br>
    &#149; <a href="make.html" title="Simple make utility">MAKE</a><br>
    &#149; <a href="makedep.html" title="Update makefile dependencies">MAKEDEP</a><br>
    &#149; <a href="me.html" title="MicroEmacs Text Editor">ME</a><br>
    &#149; <a href="obj2asm.html" title="Object file disassembler">OBJ2ASM</a><br>
    &#149; <a href="patchobj.html" title="Patch object files">PATCHOBJ</a><br>
    &#149; <a href="ctgRC.html" title="Microsoft Resource compiler">RC</a><br>
    &#149; <a href="rcc.html" title="Digital Mars Resource compiler">RCC</a><br>
    &#149; <a href="sc.html" title="Compiler command">SC</a><br>
    &#149; <a href="shell.html" title="Shell scripts">SHELL</a><br>
    &#149; <a href="smake.html" title="Manage complex projects">SMAKE</a><br>
    &#149; <a href="touch.html" title="Set file timestamps">TOUCH</a><br>
    &#149; <a href="unmangle.html" title="Format C++ mangled names">UNMANGLE</a><br>
    &#149; <a href="whereis.html" title="Search for files">WHEREIS</a><br>
    <br>

<hr><b>Porting to DMC++</b><br>

    &#149; <a href="switchtodigitalmars.html">Switching to DMC++</a><br>
    &#149; <a href="switchtodigitalmars.html#microsoft">from Microsoft</a><br>
    &#149; <a href="switchtodigitalmars.html#borland">from Borland</a><br>
    &#149; <a href="ctgPorting.html">Porting Guide</a><br>
    <br>

</small>

<hr>

</td>
<td valign="top">


<h1>Windows Prolog/Epilog Code Generation</h1>

From the IDDE, use the Windows Prolog/ 
Epilog subpage on the Build page of the IDDE's Project Settings 
dialog box.

<h2>32 Bit Windows Prolog/Epilog Code Generation</h2>
<pre>

	-WA             Win32 EXE
	-WD             Win32 DLL
	no -W switch    Win32 console EXE app
</pre>

<h2>16 Bit Windows Prolog/Epilog Code Generation</h2>
<pre>

	-W{0123ADabdefmrsuvwx-+}

	-W      Same as -W1 if no modifier switches
	-W-     Not a windows compile (default)
	-W1     Real mode Windows app/DLL
	-W2     Real mode Windows app/DLL with exported and
		callback functions marked with __export
	-W3     Real mode Windows app with smart callbacks
	-WA     Protected mode Windows EXE, with callback functions
		all marked as __export.
	-WD     Protected mode Windows DLL, with callback and exported
		functions all marked as __export.

	Modifiers:

	a       Reload DS from DS for far functions
	b       Assume DS != DGROUP
	d       Reload DS from DGROUP for far functions
	e       Generate EXPDEF records in .OBJ file for __export functions
	f       Mark all far functions as __export
	m       Generate INC BP / DEC BP to mark far stack frames
	r       Generate reload of DS only if __export or __loadds functions
	s       Reload DS from SS for far functions (smart callbacks)
	t       Use fixups instead of CS. This is needed for real mode,
		where selector values can change as code moves around.
	u       Reload DS from DGROUP for near and far functions
		(same as -mu) (same as marking all functions as __loadds)
	v       Save/restore caller's DS in far functions
	w       Assume SS != DS (same as -mw)
	x       Program will be run under Windows
	-       Turn off subsequent modifiers
	+       Turn on subsequent modifiers

		Modifers a,d,s,v are mutually exclusive.

	Equivalents:

	-W1     -Wtxema -D_WINDOWS
	-W2     -Wtxemar -D_WINDOWS
	-W3     -Wtxems -D_WINDOWS
	-WA     -Wtxrs -D_WINDOWS
	-WD     -Wtxerdw -D_WINDOWS -D_WINDLL
	-WD-r   -Wtxedw -D_WINDOWS -D_WINDLL
</pre>
<h3>We Recommend:</h3>
<ul>
	<li>    For "I don't care, just make it work", simply use -W.
		This will produce the most inefficient code.
	<li>    For maximum program speed and compactness, use the
		-WA or -WD switches.
	<li>    Use the L memory model for DLLs.
	<li>    Use the L memory model for most application programming.
		Many anachronistic Windows programming books insist
		on the S or M model, but the reasons for that have
		gone away with the obsolescence of real mode.
	<li>    Abandon real mode (Windows 3.1 has abandoned it).
	<li>    Normally use -4 (486 code) or -5 (Pentium code), unless
		you expect your code to be used on an 8088 or a 286.
		Marking your app as only running in enhanced mode will
		ensure that it won't be accidentally run on an 8088 or
		a 286.
	<li>    If you are using -WA or -WD and need to run a
		debugger on the result, use the m modifier. This
		enables many debuggers to distinguish between a
		near call frame and a far call frame.
	<li>    Declare all exported and callback functions with __export.
</ul>

<h3>Don't Do This:</h3>
<ul>
	<li> DON'T use -W3 or -WA for code to be used in a DLL.
	<li> DON'T use smart callbacks (-Ws) for code to be used in a DLL.
	<li> DON'T use -W2, -WA or -WD and then fail to mark as __export
		   those functions to be used as callbacks or exports.
	<li> DON'T use -WA or -WD for code that might be used in Windows
		   real mode.
</ul>

<h3>Microsoft C6 switch compatibility for Windows compiling:</h3>
<pre>
	MSC     SC/C++
<pre class="d_code">	-Gw     -W      Full Windows prolog/epilog <span style="color:blue">for</span> far functions
	-GW     -W2     Reduced prolog/epilog, Note 1
	-Au     -mwu    assume SS != DS and load DS on each <span style="color:blue">function</span>
	-Aw     -mw     assume SS != DS

Note 1: SC/C++ will still generate the full prolog/epilog
	<span style="color:blue">for</span> __far __export functions, MSC6 will not.
&lt;/pre&gt;

&lt;h3&gt;Microsoft C7/VC <span style="color:blue">switch</span> compatibility <span style="color:blue">for</span> Windows compiling:&lt;/h3&gt;
&lt;pre&gt;
	MSC     SC/C++
</pre>
	-Gw     -W	Full Windows prolog/epilog for far functions
	-Au     -mwu	assume SS != DS and load DS on each function
	-Aw     -mw	assume SS != DS
	-GA     -WA	optimized protected mode Windows apps
	-GD     -WD	optimized protected mode Windows DLLs
	-GEa    -Wa	load DS from AX
	-GEd    -Wd	load DS from DGROUP
	-GEe    -We	emit EXPDEF records for all exported 
			functions
	-GEf    -W-r	create prolog/epilog code for all 
			far functions
	-GEm    -Wm	add inc BP / dec BP to prolog / 
			epilog of far functions
	-GEr    -W2v	real mode, reduced prolog for 
			non-exported functions
	-GEs    -Ws	load DS from SS
	-Gq     -Wtxme	compatibility with MSC6 -GW
	-GW     -Wtxmev -D_WINDOWS     reduced prolog for real mode 
			Windows functions
</pre>

<h3>Special Feature</h3>
	The -Wb switch (assume DS != DGROUP) causes the compiler to
	issue a warning whenever a segment fixup is done to DGROUP. If
	your program is using an alternate data segment, this could
	mean that a DGROUP fixup is a program bug.
<p>
	A DGROUP fixup can be triggered (in large data model) by
	things like:
<pre>

		static int x;
		static int *px = &x;    /* DGROUP fixup generated       */
		static char *p = "abc"; /* DGROUP fixup generated       */
</pre>
	To get rid of the fixup, the pointers can be made near:
<pre>

		static int __near *px = (int __near *)&x;
		static char __near *p = "abc";
</pre>

	these will generate DGROUP relative fixups, not DGROUP segment
	fixups. Alternatively, the pointers can be initialized at
	runtime (the compiler generates code that uses DS to initialize
	segment values).
<p>
	Eliminating DGROUP segment fixups is useful for:
<ul>
	<li>    special purpose code where the data segment
		needs to be moved around.

	<li>    embedded systems where the data segment will be
		initialized from an image in ROM.

	<li>    16 bit Windows DLLs where the DLL was made to be multi-
		instanced by creating multiple copies of DGROUP
		at runtime.
</ul>
	The -Wb switch can be highly useful in finding difficult to
	track down bugs in such code. -Wb does not affect code generation
	at all, it only reports when a DGROUP segment fixup is generated.
<p>
	Note that -Wb will issue errors if you are using __loadds (because
	DS is reloaded from DGROUP) or if you are using -Wd (load DS
	from DGROUP Windows prologs).
<p>
	-W tells the compiler to ignore case when linking to make the 
	programs more compatible with 
	existing Windows programs (many of which are linked that way). 
	When developing new programs, do not ignore case, since C and 
	C++ are case-sensitive languages. Ignoring case can cause bugs that 
	are difficult to trace. 
<p>
	To compile a Windows program without ignoring case, use the 
	options -W -L/noi
<pre>
	sc -W -L/noi winprog.c 
</pre>

</pre>
<h3>References For 16 Bit Windows Prolog/Epilogs</h3>

	Chapter 21<br>
	"Programmer's Reference, Volume 1"<br>
	Microsoft Windows SDK 3.1<br>
<br>
	Chapters 7 and 19<br>
	<a href="http://www.amazon.com/exec/obidos/ASIN/1556153953/classicempire">
	"Programming Windows 3.1, Third Edition"</a><br>
	Charles Petzold<br>
	Microsoft Press<br>
	ISBN 1-55615-395-3<br>


<br><br><br><br>

</td></table>






<div id="copyright">
Copyright &copy; 1999-2006 by Digital Mars, All Rights Reserved |
Page generated by <a href="http://www.digitalmars.com/d/ddoc.html">Ddoc</a>.
</div>

</body>
</html>

