
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>

<!--
	Copyright (c) 2001-2006 by Digital Mars
	All Rights Reserved
	www.digitalmars.com
  -->

<head>
<META http-equiv="content-type" content="text/html; charset=utf-8" >
<title>Digital Mars - Trace Dynamic Profiling
</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<div id="heading">
<a href="http://www.digitalmars.com/"><IMG SRC="dmlogo.gif" BORDER=0 WIDTH=270 HEIGHT=53 ALT="www.digitalmars.com"></a>

<a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a>
| <a href="../advancedsearch.html" title="Search Digital Mars web site">Search</a>
| <a href="ctg.html" title="Compiler & Tools Guide">CTG</a>
| <a href="../rtl/rtl.html" title="Runtime Library Reference">RTL</a>
| <a href="../ugr/ugr.html" title="IDDE Reference">IDDE</a>
| <a href="../stl/index.html" title="Standard Template Library">STL</a>

	<div id="lastupdate">Last update Fri Apr 28 16:25:46 2006
</div>
</div>

<!-- Generated by Ddoc from trace.d -->




<table border=1 cellpadding=8 cellspacing=0 frame="void" summary="this table is for layout only">
<tr>
<td valign="top" class="toc" nowrap>
<small>
<center>
<form method="get" action="http://www.google.com/search">
<input id="q" name="q" size="10" value="Search" onFocus='if(this.value == "Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/ctg">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</form>
</center>

    <a href="ctg.html"><b>Compiler & Tools Guide</b></a><br>

<hr><b>Compiling</b><br>

    &#149; <a href="ctgCompilingCode.html">Compiling Code</a><br>
    &#149; <a href="C-Language-Implementation.html">C Implementation</a><br>
    &#149; <a href="CPP-Language-Implementation.html">C++ Implementation</a><br>
    &#149; <a href="ctgLanguageImplementation.html">Language Extensions</a><br>
    &#149; <a href="ctgMixingLanguages.html">Mixing Languages</a><br>
    &#149; <a href="ctgAsm.html">Assembly Language</a><br>
    &#149; <a href="ctgInlineAsm.html">Inline Assembler</a><br>
    &#149; <a href="ctgOptimizer.html">Optimizing Code</a><br>
    &#149; <a href="ctgNumerics.html">Numerics Programming</a><br>
    &#149; <a href="regular.html">Regular Expressions</a><br>
    &#149; <a href="acrtused.html">Acrtused</a><br>
    &#149; <a href="pragmas.html">Pragmas</a><br>
    &#149; <a href="precompiled.html">Precompiled Headers</a><br>
    &#149; <a href="predefined.html">Predefined Macros</a><br>
    &#149; <a href="warnings.html">Warning Messages</a><br>
    &#149; <a href="ctgCompilerErrors.html">Error Messages</a><br>
    &#149; <a href="warnings.html#runtime">Runtime Messages</a><br>
    <br>

<hr><b>Linking</b><br>

    &#149; <a href="optlink.html">Optlink</a><br>
    &#149; <a href="ctgLinkSwitches.html">Switches</a><br>
    &#149; <a href="ctgDefFiles.html">Module Definition Files</a><br>
    &#149; <a href="ctgLinkOps.html">Operation and Design</a><br>
    &#149; <a href="OptlinkErrorMessages.html">Error Messages</a><br>
    <br>

<hr><b>Win32 Programming</b><br>

    &#149; <a href="win32programming.html#win32">Win32 Programming</a><br>
    <br>

<hr><b>DOS and Win16<br>Programming</b><br>

    &#149; <a href="ctgMemoryModel.html">Memory Models</a><br>
    &#149; <a href="pointers16.html">16 Bit Pointer Types<br> and Type Modifiers</a><br>
    &#149; <a href="win32programming.html#handle">Handle Pointers</a><br>
    &#149; <a href="win32programming.html#dos">DOS</a><br>
    &#149; <a href="dos32.html">DOS 32 (DOSX)</a><br>
    &#149; <a href="win32programming.html#win16">Win16</a><br>
    &#149; <a href="win32programming.html#win16dll">Win16 DLLs</a><br>
    &#149; <a href="windowspe.html">Win16 Prolog/Epilog</a><br>
    <br>

<hr><b>C/C++ Extensions</b><br>

    &#149; <a href="contract.html">Contract Programming</a><br>
    &#149; <a href="debugstatement.html">__debug statement</a><br>
    &#149; <a href="debugstatement.html#debugdeclaration">__debug declaration</a><br>
    &#149; <a href="trace.html">Dynamic Profiling</a><br>
    &#149; <a href="html.html">Embedding C in HTML</a><br>
    <br>

<hr><b>Tools</b><br>

    &#149; <a href="bcc.html" title="Convert Borland compiler commands">BCC</a><br>
    &#149; <a href="chmod.html" title="Examine and change file attributes">CHMOD</a><br>
    &#149; <a href="cl.html" title="Convert Microsoft compiler commands">CL</a><br>
    &#149; <a href="coff2omf.html" title="Convert COFF .obj and .lib to OMF">COFF2OMF</a><br>
    &#149; <a href="coffimplib.html" title="Convert COFF import library OMF">COFFIMPLIB</a><br>
    &#149; <a href="sc.html" title="Compiler command">DMC</a><br>
    &#149; <a href="diff.html" title="Compare files">DIFF</a><br>
    &#149; <a href="diffdir.html" title="Compare directories">DIFFDIR</a><br>
    &#149; <a href="dump.html" title="Dump files in hex">DUMP</a><br>
    &#149; <a href="dumpobj.html" title="Dump object files in hex">DUMPOBJ</a><br>
    &#149; <a href="dumpexe.html" title="Dump exe files">DUMPEXE</a><br>
    &#149; <a href="exe2bin.html" title="Create .com files">EXE2BIN</a><br>
    &#149; <a href="flpyimg.html" title="Read/Write Floppy Image">FLPYIMG</a><br>
    &#149; <a href="grep.html" title="Search files for string">GREP</a><br>
    &#149; <a href="ctgHelp.html" title="Creating Help Tools">HC</a><br>
    &#149; <a href="implib.html" title="Build import libraries">IMPLIB</a><br>
    &#149; <a href="lib.html" title="Object file librarian">LIB</a><br>
    &#149; <a href="libunres.html" title="Analyze library and object files">LIBUNRES</a><br>
    &#149; <a href="make.html" title="Simple make utility">MAKE</a><br>
    &#149; <a href="makedep.html" title="Update makefile dependencies">MAKEDEP</a><br>
    &#149; <a href="me.html" title="MicroEmacs Text Editor">ME</a><br>
    &#149; <a href="obj2asm.html" title="Object file disassembler">OBJ2ASM</a><br>
    &#149; <a href="patchobj.html" title="Patch object files">PATCHOBJ</a><br>
    &#149; <a href="ctgRC.html" title="Microsoft Resource compiler">RC</a><br>
    &#149; <a href="rcc.html" title="Digital Mars Resource compiler">RCC</a><br>
    &#149; <a href="sc.html" title="Compiler command">SC</a><br>
    &#149; <a href="shell.html" title="Shell scripts">SHELL</a><br>
    &#149; <a href="smake.html" title="Manage complex projects">SMAKE</a><br>
    &#149; <a href="touch.html" title="Set file timestamps">TOUCH</a><br>
    &#149; <a href="unmangle.html" title="Format C++ mangled names">UNMANGLE</a><br>
    &#149; <a href="whereis.html" title="Search for files">WHEREIS</a><br>
    <br>

<hr><b>Porting to DMC++</b><br>

    &#149; <a href="switchtodigitalmars.html">Switching to DMC++</a><br>
    &#149; <a href="switchtodigitalmars.html#microsoft">from Microsoft</a><br>
    &#149; <a href="switchtodigitalmars.html#borland">from Borland</a><br>
    &#149; <a href="ctgPorting.html">Porting Guide</a><br>
    <br>

</small>

<hr>

</td>
<td valign="top">


<h1>Trace Dynamic Profiling</h1>

	Page swapping can cripple an otherwise fast program. Normally,
	code is written in such a manner as to group together functions
	that are conceptually related, not those that call each other.
	To minimize page swapping, functions must be grouped together that
	call each other a lot at runtime.
<p>
	Grouping functions that call each other has other benefits, even on 
	machines that have sufficient memory to run the application without 
	swapping: 
<ul>
	<li> Called functions will be more likely to be in the memory 
	cache already. 

	<li> When Windows loads a program or 
	DLL, it doesn't actually read it into memory. It simply 
	maps an address range onto the file. Then, when the 
	program executes, pages of the program are swapped 
	into memory as they are referenced. Grouping functions 
	that call each other will minimize the amount of the 
	program that actually has to be read in from disk, thus 
	minimizing load time. 
</ul>
	A compiler can determine the static calling relationships between
	functions in a program, but this has severe limitations. The compiler
	has no way to determine at compile time which connections are called
	relatively often. There is also no way to determine function calling
	relationships via virtual function dispatch, or other dispatch via
	function pointers.
<p>
	What is necessary is to gather this information at runtime, 
	preferably while running a typical application of the program. 
	Such dynamic profiling information can then be processed to yield 
	an order in which functions should be placed by the linker.

<h2>Dynamic Profiling With DMC++</h2>

	This capability is now built in to Digital Mars C++. It is currently
	only implemented for Win32 systems, but the results should be 
	directly applicable to a 16 bit version of your program.

<h3>Setting Up</h3>

	It's enabled by
	two switches working together: <b>-gt</b> and <b>-Nc</b>.
<p>
	<b>-gt</b> by itself inserts profiling code into every function, and when
	the program terminates, it prints out a log showing for each 
	function:

	<ul>
	<li> What other functions call it and how often (called the "fan in") 

	<li> What functions it calls and how often (the "fan out") 
	</ul>

	Throwing <b>-gt</b> will also predefine the macro
<pre>
	#define _DEBUG_TRACE 1
</pre>
	If <b>-Nc</b> (make all functions COMDATs) is thrown as well, profiling
	code is only inserted into global COMDAT functions, since it is
	only global COMDAT functions that the linker can adjust the link 
	order on.
<p>
	If there are many static functions, and those are to be profiled
	and grouped as well, throw the -gg (make static functions global)
	also. This assumes, of course, that all static function names in
	the -gg modules are distinct from one another and all global names.
<p>
	The program is linked normally.

<h3>Gathering the Data</h3>

	Run the program in the manner it is typically used. The trace code
	will accumulate the information, and when the program is terminated,
	the information will be written to files 'trace.log' and 'trace.def'.
	trace.log is a readable text file with a list of all the traced
	functions, along with who calls them (fan in) and who they call (fan
	out), and each time this occurs.
<p>
	Following this is listed timing data. The data are:
<pre>
	Num Calls:      Number of times the function was called.
	Tree Time:      Time used by function plus the tree times of all the
			functions it calls.
	Func Time:      Time used by a function excluding the time
			used by the functions it calls (times for functions 
			it calls that are not compiled with <b>-gt</b>, like
			RTL functions, are included in Func Time).
	Per Call:       (Func Time) / (Num Calls)
</pre>
	If multiple runs are done with the program, the profiling data is
	merged and summed with any previously existing trace.log file.
<p>
	The final output is the 'trace.def' file, which is meant to be 
	included in the linker module definition file. It contains the list 
	of the functions in the order the linker should link them.

<h3>Modifying Dynamic Profiling Behavior</h3>

	The behavior of the profiler can be modified with several
	functions that can be explicitly called in the program. They are
	prototyped in trace.h. They are implemented aa macros that expand to 
	nothing if <b>-gt</b> is not thrown.
<pre>
	void trace_term()
</pre>
	Normally, this function is called when the program exits as part of
	the static destructor list. If this list is not called, or you wish
	to stop gathering data before the end of the program (for instance, 
	to optimize for fast load), then insert a call to trace_term() at 
	the point where it is to stop.
<pre>
	int trace_setdeffilename(const char *name)
</pre>
	Set file name to use for .def file instead of trace.def.
	Returns: 0 for success, non-zero for failure
<pre>
	int trace_setlogfilename(const char *name)
</pre>
	Set file name to use for .def file instead of trace.log.
	Returns: 0 for success, non-zero for failure

<h3>Optimizing Program Load Time</h3>

	To optimize the program for fast loading, rather than fast running,
	gather the profile data only as far as the program is loaded. Then,
	call trace_term() to terminate the data gathering and write the
	output files.

<h2>Notes</h2>

<ul>
	<li> The library does not have profiling instrumentation in it, so the
	library functions are not grouped by the linker, nor is any profiling
	information collected for library functions. The extra code linked in
	to do the profiling makes use of the library functions, so if the
	library functions are instrumented, some infinite loops can occur.
	So don't recompile the library with <b>-gt</b>.

	<li> Functions declared with __declspec(naked) never get profiling
	instrumentation added to them.

	<li> The profile data gathering code will get confused if non-local jumps
	occur when things like setjmp/longjmp, Windows NT structured 
	exceptions, or C++ exceptions are used. If this profiling tool is 
	well used by customers, we'll address these shortcomings.

	<li> The timing is based on the Win32 performance timing API, which is
	accurate to about one microsecond. Unfortunately, any paging or any
	other tasks running can erratically change the timings. There is no
	real way around this besides just running the tests several times
	and averaging the results.

	<li> The overhead of the instrumentation code can distort the 
	measurements when the function times are very short. The profiler 
	tries to compensate for this, but the overhead times are not always 
	consistent.

	<li> Profiling of multithreaded apps is not supported.

	<li> Multiple EXEs and DLLs can be profiled simultaneously, but the log 
	files and def files must all be set to different names, or else 
	they will step on each other.
</ul>


<br><br><br><br>

</td></table>






<div id="copyright">
Copyright &copy; 1999-2006 by Digital Mars, All Rights Reserved |
Page generated by <a href="http://www.digitalmars.com/d/ddoc.html">Ddoc</a>.
</div>

</body>
</html>

