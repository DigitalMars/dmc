
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>

<!--
	Copyright (c) 2001-2006 by Digital Mars
	All Rights Reserved
	www.digitalmars.com
  -->

<head>
<META http-equiv="content-type" content="text/html; charset=utf-8" >
<title>Digital Mars - Lesson 5: Add a Dialog Box with ClassExpress
</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<div id="heading">
<a href="http://www.digitalmars.com/"><IMG SRC="dmlogo.gif" BORDER=0 WIDTH=270 HEIGHT=53 ALT="www.digitalmars.com"></a>

<a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a>
| <a href="../advancedsearch.html" title="Search Digital Mars web site">Search</a>
| <a href="../ctg/ctg.html" title="Compiler & Tools Guide">CTG</a>
| <a href="../rtl/rtl.html" title="Runtime Library Reference">RTL</a>
| <a href="../ugr/ugr.html" title="IDDE Reference">IDDE</a>
| <a href="../stl/index.html" title="Standard Template Library">STL</a>

	<div id="lastupdate">Last update Fri Apr 28 16:30:17 2006
</div>
</div>

<!-- Generated by Ddoc from chapter14.d -->




<table border=1 cellpadding=8 cellspacing=0 frame="void" summary="this table is for layout only">
<tr>
<td valign="top" class="toc">
<small>
<center>
<form method="get" action="http://www.google.com/search">
<input id="q" name="q" size="10" value="IDDE Search" onFocus='if(this.value == "IDDE Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/ugr">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</form>

    <a href="ugr.html"><b>IDDE<br>Reference</b></a><br><br>
</center>

<b>Part 1: Welcome to Digital Mars C++</b><br>
    1. <a href="chapter1.html">Introducing Digital Mars C++</a></br>
    2. <a href="chapter2.html">Introducing the IDDE</a></br>
<hr>
<b>Part 2: Creating an Application with Digital Mars C++</b><br>
    3. <a href="chapter3.html">Starting a Project and Defining Workspaces</a></br>
    4. <a href="chapter4.html">Generating an Application Framework</a></br>
    5. <a href="chapter5.html">Defining Classes and Their Hierarchies</a></br>
    6. <a href="chapter6.html">Editing Program Code</a></br>
    7. <a href="chapter7.html">Adding Look and Feel with Resources</a></br>
    8. <a href="chapter8.html">Testing an Application</a></br>
<hr>
<b>Part 3: Learning Digital Mars C++ by Example</b><br>
    9. <a href="chapter9.html">Introduction to the Tutorial</a></br>
    10. <a href="chapter10.html">Lesson 1: Create the DOS Application</a></br>
    11. <a href="chapter11.html">Lesson 2: Generate an Application Framework</a></br>
    12. <a href="chapter12.html">Lesson 3: Customize the Interface</a></br>
    13. <a href="chapter13.html">Lesson 4: Add Messages with ClassExpress</a></br>
    14. <a href="chapter14.html">Lesson 5: Add a Dialog Box with ClassExpress</a></br>
<hr>
<b>Part 4: More about Creating Programs</b><br>
    15. <a href="chapter15.html">More about Projects and Workspaces</a></br>
    16. <a href="chapter16.html">More about Project Build Settings</a></br>
    17. <a href="chapter17.html">More about AppExpress</a></br>
    18. <a href="chapter18.html">More about ClassExpress</a></br>
    19. <a href="chapter19.html">Class Editor Reference</a></br>
    20. <a href="chapter20.html">Hierarchy Editor Reference</a></br>
    21. <a href="chapter21.html">Text Editor Reference</a></br>
    22. <a href="chapter22.html">Using Version Control</a></br>
<hr>
<b>Part 5: More about Testing Programs</b><br>
    23. <a href="chapter23.html">Controlling and Configuring the Debugger</a></br>
    24. <a href="chapter24.html">Commands Available in Debugging Mode</a></br>
<hr>
<b>Part 6: About Managing Resources</b><br>
    25. <a href="chapter25.html">ResourceStudio Resource Editor</a></br>
    26. <a href="chapter26.html">Dialog Editor</a></br>
    27. <a href="chapter27.html">Menu, Accelerator and String Table Editors</a></br>
    28. <a href="chapter28.html">Bitmap, Cursor, Icon, and Font Editors</a></br>
    29. <a href="chapter29.html">Version Information and Custom Resource Editors</a></br>
<hr>
<b>Part 7: Appendixes</b><br>
    A. <a href="appendixa.html">Expression Evaluation</a></br>
    B. <a href="appendixb.html">IDDE Settings and Command-Line Options</a></br>
    C. <a href="appendixc.html">Using NetBuild</a></br>

</small>

<hr>


</td>
<td valign="top">


<h1>14. Lesson 5: Add a Dialog Box with ClassExpress</h1>


In Lesson 4, you learned how to use ClassExpress to add handlers for 
Windows messages. The application from that lesson is still skeletal. 
Its interface is complete, and it receives the Windows messages it 
needs to act upon, but every user action ultimately results in a call to 
a stub function. After completing Lesson 4, the next step is writing 
code that supplies functionality. 
<p>

This lesson shows you how to use some additional, powerful 
features of Digital Mars C++. To accomplish this, a body of code that 
supplies some substantial functionality has been added to the 
application you built in Lesson 4. In between the end of Lesson 4 
and the start of this lesson, only the Source window has been used 
to create or change C++ files in the project. That is, none of the new 
code has been automatically generated; it has all been manually 
entered. 
<p>

Start this lesson with the project
<tt>samples\tutorial\lesson5\start\tmlread.prj</tt>,
located in the directory where you installed 
Digital Mars C++. The first task you will perform is to build that project. 
Once you have done so, you will have a fully functional TML 
Reader. 
<p>

In the remainder of the lesson, you will implement a <b>Preferences</b>
dialog box. In addition to supplying C++ code for the start of this 
lesson, we have also already used ResourceStudio to create a dialog 
resource that defines the <b>Preferences</b> dialog box. However, this 
dialog box is not yet connected to the application. It lies dormant 
within <tt>tmlread.rc</tt>. You will perform all the tasks necessary to 
animate it and make it fully functional. 
<p>

Specifically, you'll use ResourceStudio to: 

<ul>
	<li> Add a new menu item for invoking the <b>Preferences</b> 
	dialog box 

	<li> Launch ClassExpress 
</ul>

Within ClassExpress, you'll: 

<ul>
	<li> Create a new class that represents the <b>Preferences</b> 
	dialog box 

	<li> Add a handler for the new menu item 

	<li> Add a handler to this new class for one of the buttons in 
	the dialog box 

	<li> Add data members to the new class that transfer 
	information between the application's data and the 
	controls in the dialog box. You will also specify 
	validation criteria for the values that the user enters in 
	the dialog box, so that MFC can perform automatic data 
	validation. 
</ul>


Finally, within the IDDE, you will: 

<ul>
	<li> Add code for the two new handlers 

	<li> Rebuild the project and examine the results of your 
	efforts 
</ul>


After completing this lesson, you will have: 

<ul>
	<li> Added a new menu command 

	<li> Used MFC and ClassExpress to implement a dialog box, 
	validate its data, and exchange data between the dialog 
	box and your application 
</ul>


The next section walks you through building and running the TML 
Reader. It also discusses how the Reader displays files and how to 
create a <b>Preferences</b> dialog box which lets the user configure how 
the files are displayed. 


<h2>Building and Exploring the TML Reader</h2>

This section acquaints you with the major features of the TML 
Reader. After building the Reader, you will use it to read sample files 
that contain TML formatting strings. 
<p>

Before building the Reader, you must first copy the file 
<tt>viewhdrs.h</tt> from the <tt>tutorial\tmlread</tt> directory to the 
<tt>tutorial\lesson5\backup</tt> directories. Various TMLRead 
modules include this header file, and cannot be compiled without it. 


<h3>Building the Reader</h3>

Follow the first four steps to build the TML Reader. 

<ol>
	<li> If you are not already in the IDDE, launch it. 

	<li> Open the project <tt>tmlread.prj</tt> in the directory 
	<tt>samples\tutorial\lesson5\start</tt> located 
	beneath the directory where you installed Digital Mars C++. 

	<li> Choose <b>Build</b> from the <b>Project</b> menu. 

	<li> Choose <b>Execute Program</b> from the <b>Project</b> menu to run 
	the program. The IDDE minimizes, and TMLRead is 
	launched. No file is yet displayed. 
</ol>

<h3>Exploring the capabilities of the Reader</h3>

Now use the Reader to browse two sample files that illustrate the 
kinds of formatting that the Reader can display. 

<ol>
	<li> Choose <b>Open</b> from TMLRead's <b>File</b> menu. 

	<li> In the <b>File Open</b> dialog box, select the file 
	<tt>sample.tml</tt> in the 
	<tt>samples\tutorial\lesson5\start</tt> directory, 
	then click OK. TMLRead reads, parses, and displays the 
	file. 

	<li> Scroll within the document using the arrow keys and the 
	Page Up and Page Down keys. Code within 
	<tt>CTMLReadView::OnKeyDown</tt> causes the scrolling to 
	occur. 

	<li> Now scroll by using the vertical scroll bar. In this case, 
	code within <tt>CTMLReadView::OnVScroll</tt> is 
	responsible for the scrolling. 

	<li> Drag either the left or right border of the window to 
	resize it. Notice that the ends of lines are automatically 
	adjusted so that paragraphs wrap properly, filling almost 
	all of the window's width. The handler 
	<tt>CTMLReadView::OnSize</tt> causes rewrapping to occur. 

	<li> If you are not now displaying the beginning of the file, 
	press the Home key. The heading "Contents" announces 
	the table of contents of this document, presented as a 
	hierarchical bulleted list of the major sections of 
	<tt>sample.tml</tt>. Each line in the table of contents is 
	underlined and displayed in green. These properties of 
	the text indicate that it is a hyperlink. Place the cursor 
	over any hyperlink; the cursor changes to a hand with an 
	extended index finger, a visual cue that you can 
	meaningfully click on the text. Move the cursor so that it 
	is not over a hyperlink; the cursor reverts to the default 
	cursor. This behavior is provided by 
	<tt>CTMLReadView::OnSetCursor</tt> after a necessary 
	initialization by <tt>CTMLReadView::PreCreateWindow</tt>. 

	<li> Click on the last hyperlink in the Contents section, 
	named "Hyperlinks," with the left mouse button. This 
	displays the last section of the file. The method 
	<tt>CTMLReadView::OnLButtonDown</tt> handles the mouse 
	click by determining whether or not it occurred on a 
	hyperlink; if a hyperlink is clicked, the jump occurs. 

	<li> At the end of the last paragraph, there is the following 
	hyperlink phrase: "here is a link to another sample 
	document." Click on this phrase. The file <tt>complex.tml</tt> 
	is read and displayed. Again, 
	<tt>CTMLReadView::OnLButtonDown</tt> causes the jump to 
	occur. 

	<li> Choose <b>Previous File</b> from TMLRead's <b>File</b> menu to 
	return to <tt>sample.tml</tt>. 

	<li> Examine each section of <tt>sample.tml</tt> by clicking each 
	hyperlink in the document's contents at the top of the 
	file. This will give you a good sense of the features of 
	TML, the subset of HTML (HyperText Markup Language) 
	recognized by the Reader. 

	<li> Choose <b>Print Preview</b> from TMLRead's <b>File</b> menu to see 
	a WYSIWYG display of how <tt>sample.tml</tt> would look if 
	it were printed on the current default printer. The 
	presence and functionality of the buttons at the top of 
	the Print Preview window has been supplied almost 
	entirely by MFC. When you finish looking at the Print 
	Preview display, click Close to return to the main view of 
	the Reader. 

	<li> Choose <b>Exit</b> from TMLRead's <b>File</b> menu. This closes the 
	Reader and returns you to the IDDE. 
</ol>


<h3>Turning aspects of the Reader's display into preferences</h3>

A few numerical quantities that help determine how TMLRead 
displays documents are at present hard-coded. These numbers are 
stored as int data members of CTMLReadView and are described 
in the following table: 


<dl>
<dt><b><tt>nParVSpace</tt></b>
<dd>Vertical space between paragraphs 

<dt><b><tt>nMargin</tt></b>
<dd>Amount of horizontal space between the document and 
the edges of the window 

<dt><b><tt>nIndent</tt></b>
<dd>Amount by which items in a list are offset from the left margin 
</dl>

The <tt>CTMLReadView</tt> constructor calls 
<tt>CTMLReadView::SetDefaultPrefs</tt> to initialize these data 
members with default values provided by the following enum 
constants (defined in the class declaration): 

<pre>
	eDftParVSpace = 12
	eDftMargin = 10 
	eDftIndent = 40 
</pre>


The <b>Preferences</b> dialog box lets the user alter these values, as 
shown in Figure 14-1. 

	<p>
	<img align="middle" src="figure14_1.gif">
	<p>
	[Figure 14-1 The Preferences dialog box]
	<p>

Of course, the user should be allowed to configure many other 
aspects of the Reader's display, such as colors and fonts. However, 
implementing this simple <b>Preferences</b> dialog box gives you the 
fundamental skills needed to realize more ambitious designs using 
the Digital Mars C++ tools. 
<p>

Before you connect the Reader's data with the controls of the 
<b>Preferences</b> dialog box, you need to first outfit the user interface 
with a way to call the dialog box. In the next section, therefore, 
you'll use ResourceStudio to add a menu item to TMLRead. 


<h2>Using ResourceStudio to Add a Menu Item</h2>

To add a <b>Preferences</b> item to the <b>View</b> menu of TMLRead, launch 
ResourceStudio from within the IDDE so that it loads <tt>tmlread.rc</tt>. 
To do this, follow these steps: 

<ol>
	<li> Open the Project window if it is not already open. 

	<li> Double-click on <tt>tmlread.rc</tt> in the Project window. 
	When asked if you want to use ResourceStudio to edit 
	this file, click Yes. 
	<p>

	The Browser window of ResourceStudio opens, as 
	shown in Figure 14-2. 

	<p>
	<img align="middle" src="figure14_2.gif">
	<p>
	[Figure 14-2 The Browser window of ResourceStudio]
	<p>

	<li> Select the item named Menu in the upper-left pane. The 
	lower-left pane now displays the ID of the TMLRead 
	menu, IDR_MAINFRAME. 


	<li> Double-click on IDR_MAINFRAME in the lower-left 
	pane. The pane on the right now contains a 
	representation of the TMLRead menu, shown in 
	Figure 14-3. 
	<p>

	The Property Sheet and the Test menu window also 
	open; they are described in Chapter 12, "Lesson 3: 
	Customize the Interface." 

	<p>
	<img align="middle" src="figure14_3.gif">
	<p>
	[Figure 14-3 ResourceStudio displaying the TMLRead menu]
	<p>

	<li> In the right pane, click on the item MENUITEM <tt>Status 
	Bar</tt> to select it. This item is the last one belonging to the 
	POPUP View item. When a new menu item is added, it 
	will appear beneath this one. 

	<li> Choose <b>New Item</b> from the <b>Menu</b> menu in the Browser 
	window. This inserts a new item whose text is <tt>Item</tt>, and 
	creates a new ID for it. The Property Sheet, shown in 
	Figure 14-4, shows these settings. 

	<p>
	<img align="middle" src="figure14_4.gif">
	<p>
	[Figure 14-4 The Property Sheet after adding a new item]
	<p>

	<li> Click on the Property Sheet to make it active. 

	<li> Click on the General tab near the top of the window to 
	ensure that the General page is displayed. 

	<li> In the ID textbox, type ID_VIEW_PREFS to change the 
	ID name. 

	<li> In the text textbox, type <tt>&Preferences</tt>.... 

	<li> Click on the Connect tab. 

	<li> On this page, type the string <tt>Customize the 
	appearance of the view</tt>. This prompt will appear 
	in the status bar whenever the <b>Preferences</b> item is 
	selected. 

	<li> Save your work by choosing <b>Save</b> from the Browser 
	window's <b>File</b> menu. 

	<li> Close the Browser window, close the ResourceStudio 
	Shell window (and with it, the Property Sheet), and 
	return to the IDDE. 
</ol>


You have now created the desired menu item. However, TMLRead 
does not yet contain a command handler for ID_VIEW_PREFS. In 
the next section, you will add one using ClassExpress, in which the 
bulk of the remaining work will take place. 
<p>


Two command handlers must be added— one for ID_VIEW_PREFS, 
the other for the Default button of the <b>Preferences</b> dialog box. 
Thus, a class must be created that represents the <b>Preferences</b> dialog 
box in the same way that CAboutDlg represents the <b>About</b> dialog 
box. The handler for the Default button will be a method for this 
new class. In the next section, you use ClassExpress to add the 
CPrefDialog class. 


<h2>Using ClassExpress to Create a New Dialog Class</h2>

Follow these steps to create a class that corresponds to the 
<b>Preferences</b> dialog box: 

<ol>
	<li> Launch ClassExpress by choosing <b>ClassExpress</b> from 
	the IDDE's Tools menu. 

	<li> Click the Add Class button. The <b>Add Class</b> dialog box 
	opens, as shown in Figure 14-5. ClassExpress detects that 
	a new dialog box has been added to the project, and 
	assumes that you want to create a corresponding class. 
	<p>

	It initializes the selections in the Class Type and Dialog 
	ID drop-down lists to reflect this assumption: Class Type 
	is set to Dialog, and Dialog ID to IDD_PREFDIALOG. 

	<p>
	<img align="middle" src="figure14_5.gif">
	<p>
	[Figure 14-5 The Add Class dialog box]
	<p>

	The focus is in the New Class Name editbox. 
	ClassExpress has suggested the name <tt>CTestDialog</tt> 
	and has selected the substring <tt>Test</tt> so that you can 
	change it just by typing. It has also suggested 
	<tt>TestDial.cpp</tt> as the name of the implementation file. 

	<li> Type <tt>Pref</tt> to change the name of the dialog class to 
	<tt>CPrefDialog</tt>. Notice that ClassExpress accordingly 
	changes the suggested name of the implementation file 
	to <tt>PrefDial.cpp</tt>. 

	<li> Click OK in the <b>Add Class</b> dialog box to accept the 
	settings. ClassExpress confirms the operation with a 
	message box. 

	<li> Click OK to close this message box. This returns you to 
	the ClassExpress window, which displays the Message 
	Maps page, as shown in Figure 14-6. 

	<p>
	<img align="middle" src="figure14_6.gif">
	<p>
	[Figure 14-6 ClassExpress displaying the Message Maps page]
</ol>


<h2>Using ClassExpress to Add Methods</h2>

In this section, you'll add two methods that respond to user actions. 
One opens the <b>Preferences</b> dialog box when the <b>Preferences</b> 
menu item is chosen, and updates the Reader's display if the OK 
button is clicked in the dialog box. The other method handles the 
clicking of the Default button in the <b>Preferences</b> dialog box. You 
will see later why it is unnecessary to add handlers for the OK and 
Cancel buttons. 
<p>

First you'll add a method that handles the command generated when 
<b>Preferences</b> is chosen from the <b>View</b> menu. This method also is 
responsible for updating the application to reflect any changed 
preferences. Then, you'll add a method that responds to a click on 
the Default button of the <b>Preferences</b> dialog box. 
<p>

The procedure in each case is similar to the one that you used in 
Lesson 4. The results of your actions also will be similar: 
ClassExpress adds these methods to class declarations, add entries to 
Message Maps, and create stub functions for the methods. When you 
return to the IDDE, you will only need to write the code for these 
two methods. 


<h3>Creating a handler for the Preferences command</h3>

You will use ClassExpress to bind the ID_VIEW_PREFS command 
ID to a new method that creates and initializes an object of class 
<tt>CPrefDialog</tt>, and then uses this object to display the dialog box. 
When the user closes the dialog box, this method determines 
whether the user clicked OK or Cancel. If OK was clicked, 
application data must be updated, and the view must be redrawn. 
<p>

This method needs access to data members of <tt>CTMLReadView</tt> in 
order to initialize the dialog box and to update those data members 
if the user clicks OK. Because of these requirements, the method is 
added to the class <tt>CTMLReadView</tt>. 

<ol>
	<li> Select the class <tt>CTMLReadView</tt> in the Class combobox 
	on the Message Maps page. 

	<li> In the Control IDs in the Class listbox, select 
	ID_VIEW_PREFS, the ID of the command issued when 
	the <b>Preferences</b> item in the <b>View</b> menu is chosen. The 
	listbox on the right, Windows Messages, now contains 
	the two items, COMMAND and UPDATE_COMMAND_UI. 

	<li> Double-click on COMMAND in the Windows Messages 
	listbox. The <b>Method Name</b> dialog box opens, asking 
	you for a name for the method that is called when 
	<b>Preferences</b> is chosen. ClassExpress suggests the name 
	OnViewPrefs for this method. 

	<li> Click OK in the <b>Method Name</b> dialog to accept the 
	name <tt>OnViewPrefs</tt>. 
</ol>

ClassExpress adds this method to the declaration of class 
<tt>CTMLReadView</tt> in the header file for the class. It also updates the 
class implementation file by adding an entry to the class's Message 
Map, and by adding a stub function 
<tt>CTMLReadView::OnViewPrefs</tt>. 


<h3>Creating a handler for the Default button of the Preferences dialog box</h3>

You will now add a method to <tt>CPrefDialog</tt> for handling clicks on 
the Default button in the <b>Preferences</b> dialog box. This method must 
update the values displayed in the controls of the dialog box with 
the same default values used to initialize the <tt>CTMLReadView</tt> data 
members <tt>nParVSpace</tt>, <tt>nMargin</tt>, and <tt>nIndent</tt>. Because the 
default values are public enum constants, this method requires no 
access privileges to <tt>CTMLReadView</tt>. 
<p>

Follow these steps to add this method: 

<ol>
	<li> Select the class <tt>CPrefDialog</tt> in the Class combobox 
	on the Message Maps page. 

	<li> In the Control IDs in Class listbox, select 
	ID_PREFS_DEFAULT, the ID of the Default button. The 
	listbox on the right, Windows Messages, now contains 
	the two items BN_CLICKED and BN_DOUBLECLICKED. 
	<p>

	<b>Note:</b> 
	These so-called messages are actually notifications 
	that the button sends to its parent, the <b>Preferences</b> 
	dialog box, via WM_COMMAND messages. <tt>BN_<i>xxx</i></tt> 
	stands for Button Notification. The <tt>BN_<i>xxx</i></tt> 
	identifiers are defined in <tt>windows.h</tt>. 
	<p>

	<li> In the Windows Messages listbox, double-click on 
	BN_CLICKED, the notification sent when the Default 
	button is clicked. The <b>Method Name</b> dialog box opens, 
	suggesting <tt>OnClickedPrefsDefault</tt> for the method 
	name. 

	<li> Change this name to <tt>OnDefault</tt>. 

	<li> Click OK in the <b>Method Name</b> dialog box to return to 
	the ClassExpress main window. 
</ol>


As it did when you added <tt>CTMLReadView::OnViewPrefs</tt>, 
ClassExpress adds a prototype for <tt>OnDefault</tt> to the declaration of 
the class <tt>CPrefDialog</tt> in the class's header file. It also updates the 
class implementation file by adding an entry to the class's Message 
Map. It also adds a stub function <tt>CPrefDialog::OnDefault</tt>. 
<p>

Once you are back in the IDDE, you must write code to implement 
these two handlers. To have the handlers to perform their intended 
tasks, you must first make it possible to transfer data into and out of 
the controls of the <b>Preferences</b> dialog box. MFC and ClassExpress 
make it surprisingly easy not only to transfer data to and from a 
dialog box, but also to validate data that the user has entered into a 
dialog's controls. Adding these capabilities is addressed in the next 
section, the last one in which you use ClassExpress. 


<h2>Adding Dialog Data Exchange and Validation</h2>

Windows programs written in C traditionally exchange data with 
dialog boxes by fetching data from each control in a manner 
particular to the control type (edit control, radio button, check box, 
and so on) and particular to the intended type of the data (string, 
integer, long integer, and so on). Then, the extracted data is usually 
stored in <tt>static</tt> storage. Also, there are rarely any general-purpose 
facilities from Windows API for validating data that the user enters in 
a dialog box— placing another burden on the programmer. 
<p>


MFC and ClassExpress add order, simplicity and elegance to this 
situation. To use the MFC model of dialog box data exchange and 
validation, you must first add data members to the dialog class. (This 
replaces the ad hoc collection of <tt>static</tt> data favored by the 
traditional approach.) You use ClassExpress to associate data 
members with controls in the dialog box. MFC then automates the 
transfer of data between the dialog's controls and the dialog class 
data members. When adding a data member with ClassExpress, you 
also specify its type and the validation criteria in the associated 
control. MFC uses this information to perform its automatic data 
validation. 
<p>


In the next step, you'll add data members to the <tt>CPrefDialog</tt> 
class using the Data Transfer page of ClassExpress. After you 
complete this task, there is a review of the changes that ClassExpress 
has made to the <tt>CPrefDialog</tt> source files, and an explanation of 
how MFC accomplishes data exchange and validation. 
<p>

Throughout this section, you'll work with the <tt>CPrefDialog</tt> class 
on the Data Transfer page of ClassExpress. Perform the following 
steps to set up ClassExpress for this part of the lesson: 


<ol>
	<li> In the upper-left listbox, select the second item, Data 
	Transfer. ClassExpress opens the Data Transfer page in 
	the larger pane on the right, as shown in Figure 14-7. 

	<p>
	<img align="middle" src="figure14_7.gif">
	<p>
	[Figure 14-7 ClassExpress displaying the Data Transfer page]
	<p>

	<li> Be sure that <tt>CPrefDialog</tt> is selected in the Class Name 
	combobox at the top of the Data Transfer page. 
</ol>


<h3>Adding data members to CPrefDialog</h3>

To add data members, to CPref Dialog, carry out the following steps: 

<ol>
	<li> Click on the Add Variable button. The <b>Add Member 
	Variable</b> dialog box opens, as shown in Figure 14-8. 

	<p>
	<img align="middle" src="figure14_8.gif">
	<p>
	[Figure 14-8 The Add Member Variable dialog box]
	<p>

	<li> Select IDC_PARVSPACE from the Control ID combobox. 

	<li> Change the Member Variable Name to <tt>nParVSpace</tt>. 
	(For simplicity, you can name the member variables of 
	<tt>CPrefDialog</tt> the same as the members of <tt>CTMLReadView</tt> 
	to which they correspond.) 

	<li> For the DDX Type option, select Value. 
	<p>

	In fact, the Control Name combobox does not contain 
	symbolic indentifiers for the three edit controls in the 
	Preferences dialog box. Rather, you see only the integer 
	resource ids of these controls. Select 3001, the resource 
	id of the Paragraph Spacing edit control. 
	<p>

	<li> In the Variable Type combobox, select <tt>int</tt>. Two new 
	textboxes, Minimum Value and Maximum Value, appear 
	at the bottom of the dialog box, as shown in Figure 14-9. 

	<p>
	<img align="middle" src="figure14_9.gif">
	<p>
	[Figure 14-9 Add Member Variable with Variable Type set to int]
	<p>

	<li> Type 0 in the Minimum Value field. 

	<li> Type 100 in the Maximum Value field. 

	<li> Click OK in the <b>Add Member Variable</b> dialog box. The 
	Data Transfer page now reflects this additional data 
	member and its validation criteria in the Control ID and 
	Variables list, as shown in Figure 14-10. 

	<p>
	<img align="middle" src="figure14_10.gif">
	<p>
	[Figure 14-10 The Data Transfer page after adding nParVSpace]
	<p>

	<li> Follow the procedure described in steps 3 through 10 of 
	the previous task to add an <tt>int</tt> variable named 
	<tt>nMargin</tt> associated with the control IDC_MARGIN. Set 
	its minimum and maximum values to 0 and 50, 
	respectively. 
	<p>

	In fact, the Control Name combobox does not contain 
	symbolic identifiers for the three edit controls in the 
	Preferences dialog box. Rather, you see only the integer 
	resource ids of these controls. Therefore, add a data 
	member corresponding to the control 3004, the resource 
	id of the Margin edit control. 
	<p>

	<li> Then, follow steps 3 through 10 to add a final <tt>int</tt> 
	variable, <tt>nIndent</tt>, associated with the control 
	IDC_INDENT. Sets its minimum and maximum values to 
	0 and 120, respectively. 
	<p>

	In fact, the Control Name combobox does not contain 
	symbolic identifiers for the three edit controls in the 
	Preferences dialog box. Rather, you see only the integer 
	resource ids of these controls. Therefore, add a data 
	member corresponding to the control 3005, the resource 
	id of the Indent edit control. 
</ol>


To return to the IDDE, click the Close button. The IDDE's Project 
window now lists the source file <tt>prefdial.cpp</tt>. 


<h3>Seeing the changes in the CPrefDialog source files</h3>

As a result of adding data members to <tt>CPrefDialog</tt>, ClassExpress 
makes various changes to the header and implementation files of the 
class <tt>CPrefDialog</tt> including: 


<h4>Changes to the class definition</h4>

ClassExpress added the following lines to the declaration of 
<tt>CPrefDialog</tt> in <tt>prefdial.h</tt>: 

<pre>
	// Dialog Data
	    //{{ AFX_DATA(CPrefDialog) 
	    enum { IDD = IDD_PREFDIALOG };
	    int nParVSpace; 
	    int nMargin;
	    int nIndent; 
	    //}} AFX_DATA 

	// Implementation
	protected: 
	    virtual void DoDataExchange(CDataExchange* pDX); // DDX/ DDV support 
</pre>


The comments help ClassExpress find where subsequently added 
data members should be declared. (The variables that ClassExpress 
adds are public.) The enum constant IDD is used by the 
<tt>CPrefDialog</tt> constructor as an argument to the constructor of its 
base class, <tt>CDialog</tt>. 


<h4>Changes to the constructor</h4>

ClassExpress changes the <tt>CPrefDialog</tt> constructor so that it 
appears as follows: 


<pre>
	CPrefDialog::CPrefDialog(CWnd* pParent /*= NULL*/)
	   : CDialog(CPrefDialog::IDD, pParent) 
	{
	    //{{ AFX_DATA_INIT(CPrefDialog)
	    nParVSpace = 0; 
	    nMargin = 0;
	    nIndent = 0; 
	    //}} AFX_DATA_INIT
	} 
</pre>


The AFX_DATA_INIT comments are used by ClassExpress to 
delimit the location within the constructor where data members 
participating in data exchange and validation should be initialized. 
All the data members that you added are set to 0. Therefore, before 
it displays the <b>Preferences</b> dialog box, the handler 
<tt>CTMLReadView::OnViewPrefs</tt> first sets these <tt>CPrefDialog</tt> data 
members to the values of the <tt>CTMLReadView</tt> data members to 
which they correspond. 


<h4>Changes to the DoDataExchange function</h4>

The protected member function <tt>DoDataExchange</tt> is the 
workhorse that transfers data between the added data members and 
the controls of the <b>Preferences</b> dialog box. It also validates the 
values entered into the controls when the user clicks OK. (The 
acronym DDX stands for Dialog Data eXchange; DDV stands for 
Dialog Data Validation.) ClassExpress also writes the 
<tt>DoDataExchange</tt> function, using the information you gave it when 
you added each variable. The implementation of the function, in 
<tt>PrefDial.cpp</tt>, looks like this: 


<pre>
	void CPrefDialog::DoDataExchange(CDataExchange* pDX) 
	{
	    CDialog::DoDataExchange(pDX); 
	    //{{ AFX_DATA_MAP(CPrefDialog)
	    DDX_Text(pDX, IDC_PARVSPACE, nParVSpace); 
	    DDV_MinMaxInt(pDX, nParVSpace, 0, 100);
	    DDX_Text(pDX, IDC_MARGIN, nMargin); 
	    DDV_MinMaxInt(pDX, nMargin, 0, 50);
	    DDX_Text(pDX, IDC_INDENT, nIndent); 
	    DDV_MinMaxInt(pDX, nIndent, 0, 120);
	    //}} AFX_DATA_MAP 
	} 
</pre>


Again, the AFX_DATA_MAP comments serve only as delimiters used 
by ClassExpress when adding data members. 
<p>


The overloaded <tt>DDX_<i>xxx</i></tt> and <tt>DDV_<i>xxx</i></tt> functions are declared in the 
MFC include file <tt>afxdd_.h</tt>. These functions all take a pointer,
<tt>pDX</tt>, 
to a <tt>CDataExchange</tt> object. This object contains two public data 
members that enable the functions. 
<p>


The <tt>CDataExchange</tt> data member <tt>m_bSaveAndValidate</tt> 
informs the functions of the direction of the transfer. If 
<tt>m_bSaveAndValidate</tt> is <tt>TRUE</tt>, then the transfer is from the 
controls to the data members; if this data member is <tt>FALSE</tt>, the 
transfer is from the data members to the controls. The <tt>DDX_<i>xxx</i></tt> 
functions perform the appropriate transfer in each case. If 
<tt>m_bSaveAndValidate</tt> is <tt>TRUE</tt>, each <tt>DDV_<i>xxx</i></tt> validation function 
checks whether the data meets the validation criteria it implements. 
If the data fails to meet the criteria, the validation function opens a 
message box informing the user, and sets the focus to the control 
containing the invalid value. If <tt>m_bSaveAndValidate</tt> is <tt>FALSE</tt>, 
the validation functions do nothing. 
<p>


The <tt>CDataExchange</tt> data member <tt>m_pDlgWnd</tt> is a pointer to the 
<tt>CWnd</tt> whose data is being transferred and validated. The presence of 
this data member saves <tt>DoDataExchange</tt> from having to pass the 
this pointer to every <tt>DDX_<i>xxx</i></tt> and <tt>DDV_<i>xxx</i></tt> function. 
<p>

<b>Note:</b> 
Because <tt>DoDataExchange</tt> is a <tt>CWnd</tt> member 
function and <tt>m_pDlgWnd</tt> is a <tt>CWnd*</tt>, DDX and 
DDV can be used with any window, and not just 
with those derived from <tt>CDialog</tt>. 
<p>


<tt>DoDataExchange</tt> is called by the <tt>UpdateData</tt> function 
whenever data exchange must take place. You never call it directly. 
In particular, <tt>DoDataExchange</tt> is called when a window or dialog 
box is first opened to initialize its controls. It is also called by the 
<tt>CDialog</tt> member function <tt>OnOK</tt> when a user clicks on a button in 
the dialog box with an <tt>ID</tt> of <tt>IDOK</tt>. Thus in the <b>Preferences</b> dialog 
box, the inherited handler for the OK button already performs data 
transfer and validation, so you do not need to supply an override. 
Similarly, the <tt>CDialog</tt> member function <tt>OnCancel</tt> simply 
terminates a dialog box— behavior completely suitable for the 
<b>Preferences</b> dialog box. 
<p>


With these concepts in mind, you can clearly see the purpose and 
effect of the handlers that you supply in the next task. 


<h2>Writing Code for the New Handlers</h2>

Now, the only task left is to provide implementations of the handlers 
<tt>CTMLReadView::OnViewPrefs</tt> and 
<tt>CPrefDialog::OnDefault</tt>. Both handlers are straightforward. 


<h3>Implementing CTMLReadView::OnViewPrefs</h3>

Carry out these steps to create the handler: 

<ol>
	<li> In the Project window, double-click on <tt>tmlrdvw.cpp</tt>. 
	This opens a Source window in which you can edit the 
	file <tt>tmlrdvw.cpp</tt>. 

	<li> Find the group of <tt>#include</tt> statements toward the top 
	of the file. Add this line after the last <tt>#include</tt> 
	statement: 

<pre>
	#include "prefdial.h" 
</pre>

	<li> Find the function <tt>CTMLReadView::OnViewPrefs</tt>. (It 
	is at the bottom of the file.) 

	<li> Edit the function by entering the following code. (You 
	may omit the lengthy comments.) 

<pre>
	void CTMLReadView::OnViewPrefs()
	{   
	    CPrefDialog dlgPref; 

	    // Initialize dlgPref data members with
	    // current values from CTMLReadView 
	    //
	    dlgPref.nParVSpace = nParVSpace; 
	    dlgPref.nMargin = nMargin;
	    dlgPref. nIndent = nIndent; 

	    // Display the dialog modally.
	    // If user clicks OK, DoDataExchange 
	    // will be called to validate data in
	    // the controls. If the controls hold valid 
	    // values, their contents will be
	    // transferred to the CPrefDialog data 
	    // members. In that case, we must transfer
	    // the values to the corresponding 
	    // CTMLReadView data members.
	    // 
	    if (dlgPref. DoModal() == IDOK)
	    {   
		// Transfer the data to our view class
		// 
		nParVSpace = dlgPref.nParVSpace;
		nMargin = dlgPref.nMargin; 
		nIndent = dlgPref.nIndent; 

		// Make sure that the view is redrawn
		// to reflect the new preferences 
		//
		bWordsWrapped = FALSE; 
		OnUpdate(NULL, 0L, NULL);
	    } 
	}
</pre>

	<li> Save your work by choosing <b>Save</b> from the <b>File</b> menu of 
	the Source window. 

	<li> Close the Source window by clicking on the close box in 
	the upper-left corner of the window (on the caption bar). 
</ol>


<h3>Implementing CPrefDialog::OnDefault</h3>

This handler is even simpler. To create it, perform these steps: 

<ol>
	<li> In the Project window, double click on <tt>prefdial.cpp</tt>. 
	This opens a Source window in which you can edit the 
	file <tt>prefdial.cpp</tt>. 

	<li> Find the group of <tt>#include</tt> statements, toward the top 
	of the file. Add this statement to the end of the group: 

<pre>
	#include "viewhdrs.h" 
</pre>

	<li> Find the function <tt>CPrefDialog::OnDefault</tt>. (It is at 
	the bottom of the file.) 

	<li> Edit the function by entering the following code. (You 
	may omit the lengthy comments.) 


<pre>
	void CPrefDialog::OnDefault()
	{   
	    // Set data members to default values
	    // 
	    nParVSpace = CTMLReadView::eDftParVSpace;
	    nMargin = CTMLReadView::eDftMargin; 
	    nIndent = CTMLReadView::eDftIndent; 

	    // Transfer these values to the controls. 
	    // UpdateData calls DoDataExchange to effect 
	    // the transfer. The argument determines the 
	    // direction of the transfer: 
	    // TRUE causes values to move from the 
	    // controls to the data members; 
	    // FALSE, used here, transfers the values of 
	    // the data members to the controls. 
	    // UpdateData uses its argument to set the 
	    // m_bSaveAndValidate data member of the 
	    // CDataExchange object whose address 
	    // it passes to DoDataExchange. 
	    // 
	    UpdateData(FALSE); 
	}
</pre>

	<li> Save your work by choosing <b>Save</b> from the <b>File</b> menu of 
	the Source window. 
</ol>


You have now completed all the tasks necessary for the 
<b>Preferences</b> dialog box to be fully functional. To conclude this 
lesson, you will rebuild TMLRead and test the dialog box. 


<h2>Rebuild and Test TMLRead</h2>

To verify that your work has achieved the desired goal, rebuild and 
run the Reader, making it a point to use the new features. To do this, 
follow these steps: 

<ol>
	<li> Choose <b>Build</b> from the <b>Project</b> menu to incorporate the 
	changes you have made into the executable file 
	<tt>tmlread.exe</tt>. 

	<li> Choose <b>Execute Program</b> from the <b>Project</b> menu to 
	run the Reader. 

	<li> Choose <b>Open</b> from the <b>File</b> menu of TMLRead. Again, 
	load the file <tt>sample.tml</tt>. 

	<li> Choose <b>Preferences</b> from the <b>View</b> menu of TMLRead. 

	<li> Enter 25 into all three edit controls. 

	<li> Click on the Default button to verify that the 
	<tt>CPrefDialog</tt> data members are set to default values 
	by <tt>CPrefDialog::OnDefault</tt>. 

	<li> Click Cancel. You should see no change in the display of 
	<tt>sample.tml</tt>. 

	<li> Again, choose <b>Preferences</b> from the <b>View</b> menu of 
	TMLRead. 

	<li> Change the values to 150, 40, and 10, respectively. 

	<li> Click OK. Observe the message box informing you of 
	invalid data. 

	<li> Click OK to close the message box. The focus returns to 
	the editbox containing 150. 

	<li> Continue experimenting with the <b>Preferences</b> dialog 
	box, eventually clicking OK when valid data is entered in 
	the controls. After you have confirmed that the dialog 
	box is performing as you want, exit the program by 
	choosing <b>Exit</b> from the Reader's </b>File</b> menu. This returns 
	you to the IDDE. 
</ol>

<h2>Summary</h2>

In this lesson, you learned: 

<ul>
	<li> How to use the ResourceStudio to add a new menu item 

	<li> How to use ClassExpress to add a handler that responds 
	to the choice of that menu item 

	<li> How to use ClassExpress and MFC to implement a dialog 
	box, validate its data, and exchange data between the 
	dialog box and your application 
</ul>


This concludes the tutorial section. These lessons have been an 
instructive introduction to the capabilities of Digital Mars C++. By this 
point, you will have acquired the techniques and knowledge you 
need to apply the features of Digital Mars C++ to your own projects. 


<br><br><br><br>

</td></table>







<div id="copyright">
Copyright &copy; 1999-2006 by Digital Mars, All Rights Reserved |
Page generated by <a href="http://www.digitalmars.com/d/ddoc.html">Ddoc</a>.
</div>

</body>
</html>

